<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>던파 요괴 섬멸 수익 계산기</title>
  <style>
    :root {
      --primary: #3b5bb3;
      --secondary: #1f3050;
      --accent: #ff6e40;
      --text: #333;
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --border: #ddd;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', sans-serif;
    }
    body {
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
      /* 기본 좌측 정렬 (중앙 정렬 제거) */
      text-align: left;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      /* 중앙 정렬 제거 */
      margin-bottom: 30px;
    }
    header h1 {
      color: var(--primary);
      margin-bottom: 10px;
    }
    header p {
      color: var(--secondary);
    }
    .card {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h2 {
      color: var(--primary);
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }
    .item-price {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .price-text {
      font-size: 18px;
      font-weight: bold;
    }
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: var(--secondary);
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .reward-list {
      margin: 15px 0;
    }
    .reward-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .reward-item:last-child {
      border-bottom: none;
    }
    .reward-item .amount {
      color: #28a745;
      font-weight: bold;
    }
    /* 기대 수익 결과 영역 - 페이지 최상단에 위치 */
    #total-profit {
      padding: 15px;
      background-color: #f0f8ff;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: bold;
    }
    .profit-positive {
      color: #28a745;
      font-weight: bold;
    }
    .profit-negative {
      color: #dc3545;
      font-weight: bold;
    }
    .profit-summary {
      font-size: 20px;
      margin-top: 10px;
      padding: 15px;
      background-color: #e9f5ff;
      border-radius: 6px;
      font-weight: bold;
    }
    .api-notice {
      font-size: 12px;
      color: #777;
      margin-top: 20px;
      text-align: left;
    }
    .hidden {
      display: none;
    }
    .data-source {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
      font-style: italic;
      text-align: left;
    }
    .total-row {
      border-top: 2px solid var(--border);
      margin-top: 10px;
      padding-top: 10px;
      font-weight: bold;
      font-size: 18px;
    }
    .subtotal-row {
      margin-top: 10px;
      padding-top: 10px;
      font-weight: bold;
      color: #1f3050;
    }
    .api-error {
      color: #dc3545;
      margin-top: 10px;
      padding: 8px;
      background-color: #f8d7da;
      border-radius: 4px;
      display: none;
    }
    .market-price {
      font-weight: bold;
      margin-left: 5px;
      color: var(--primary);
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .status-success {
      background-color: #28a745;
    }
    .status-error {
      background-color: #dc3545;
    }
    .status-loading {
      background-color: #ffc107;
      animation: blink 1s infinite;
    }
    .debug-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      font-style: italic;
    }
    .item-info {
      display: flex;
      flex-direction: column;
    }
    .untradable {
      font-style: italic;
      font-size: 14px;
      color: #777;
    }
    .total-value-display {
      font-size: 20px;
      font-weight: bold;
      padding: 10px;
      background-color: #e9f5ff;
      border-radius: 6px;
      margin-top: 15px;
    }
    .untradable-value {
      color: #1f3050;
    }
    .total-sum-value {
      color: var(--primary);
    }
    @keyframes blink {
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 페이지 최상단에 기대 수익 결과 표시 -->
    <div id="total-profit">
      시세를 갱신하여 기대 수익을 계산해보세요.
    </div>

    <header>
      <h1>던전앤파이터 요괴 섬멸 수익 계산기</h1>
      <p>실제 200회 데이터 기반 요괴 섬멸 컨텐츠의 기대 수익 계산</p>
    </header>

    <div class="card">
      <h2>아이템 경매장 시세</h2>
      <div id="marketPrices">
        <!-- 가격 정보가 여기에 표시됩니다 -->
        <div class="item-price">
          <div>가격 정보를 불러오는 중입니다...</div>
        </div>
      </div>
      <div class="item-price">
        <button id="refreshBtn">시세 갱신</button>
      </div>
      <div id="loadingContainer" class="hidden">
        <span>경매장 정보를 불러오는 중</span>
        <div class="loading"></div>
      </div>
      <div id="apiError" class="api-error"></div>
      <div id="debugInfo" class="debug-info hidden"></div>
    </div>

    <div class="card">
      <h2>요괴 섬멸 평균 보상 (1회당)</h2>
      <div class="reward-list" id="rewardList">
        <!-- 보상 항목들이 여기에 추가됩니다 -->
      </div>
      <div id="totalValueDisplay" class="total-value-display">
        <!-- 총 기대가치가 여기에 표시됩니다 -->
      </div>
      <p class="data-source">* 200회 실행 데이터 기반 평균 계산</p>
    </div>

    <div class="card" id="resultCard">
      <h2>기대 수익 계산 결과</h2>
      <div class="result-container" id="resultContainer">
        <p>시세를 갱신하여 기대 수익을 계산해보세요.</p>
      </div>
    </div>

    <p class="api-notice">* 경매장 API를 통해 실시간 가격 정보를 제공합니다.</p>
  </div>

  <script>
    // API 키 설정
    const API_KEY = 'dA1z1Asq6LFor0nqdlI971tBmBXuZc8E';
    
    // 디버그 모드 설정
    const DEBUG_MODE = true;
    
    // DOM 요소
    const marketPricesEl = document.getElementById('marketPrices');
    const refreshBtn = document.getElementById('refreshBtn');
    const loadingContainer = document.getElementById('loadingContainer');
    const rewardListEl = document.getElementById('rewardList');
    const resultContainer = document.getElementById('resultContainer');
    const totalProfitEl = document.getElementById('total-profit');
    const apiErrorEl = document.getElementById('apiError');
    const debugInfoEl = document.getElementById('debugInfo');
    const totalValueDisplayEl = document.getElementById('totalValueDisplay');
    
    // 요괴 섬멸 보상 데이터 (200회 실행 결과 기반)
    const yokaiRewards = [
      { id: 'remnant', name: '요기의 잔흔', avgQuantity: 25.97, price: 5000, fixedPrice: true, tradable: false },
      { id: 'remnant-tradable', name: '요기의 잔흔(1회 교환 가능)', avgQuantity: 3.125, price: 0, searchName: '요기의 잔흔(1회 교환 가능)', tradable: true },
      { id: 'lion-core', name: '무결점 라이언 코어', avgQuantity: 20.68, price: 0, searchName: '무결점 라이언 코어', tradable: true },
      { id: 'harmony', name: '무결점 조화의 결정체', avgQuantity: 9.435, price: 0, searchName: '무결점 조화의 결정체', tradable: true },
      { id: 'clue', name: '형상화된 요기의 단서', avgQuantity: 0.135, price: 0, searchName: '형상화된 요기의 단서', tradable: true, npcPrice: 90000 },
      { id: 'gold', name: '골드', avgQuantity: 207360.795, price: 1, fixedPrice: true, tradable: true }
    ];
    
    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', function() {
      // 초기 UI 설정
      initializeUI();
      
      const USE_TEST_DATA = false;
      
      if (USE_TEST_DATA) {
        loadTestData();
      } else {
        fetchAllPrices();
      }
      
      refreshBtn.addEventListener('click', function() {
        if (USE_TEST_DATA) {
          loadTestData();
        } else {
          fetchAllPrices();
        }
      });
      
      if (DEBUG_MODE) {
        debugInfoEl.classList.remove('hidden');
      }
    });

    // UI 초기화
    function initializeUI() {
      updateMarketPricesUI();
      displayRewardInfo();
    }

    // 테스트 데이터 로드
    function loadTestData() {
      refreshBtn.disabled = true;
      loadingContainer.classList.remove('hidden');
      apiErrorEl.style.display = 'none';
      
      setTimeout(() => {
        yokaiRewards.forEach(reward => {
          if (reward.id === 'remnant-tradable') {
            reward.price = 10500;
            reward.avgPrice = 10500;
            reward.status = 'success';
          } else if (reward.id === 'lion-core') {
            reward.price = 22000;
            reward.avgPrice = 22000;
            reward.status = 'success';
          } else if (reward.id === 'harmony') {
            reward.price = 32000;
            reward.avgPrice = 32000;
            reward.status = 'success';
          } else if (reward.id === 'clue') {
            reward.price = 550000;
            reward.avgPrice = 550000;
            reward.status = 'success';
          }
        });
        
        updateMarketPricesUI();
        displayRewardInfo();
        calculateExpectedProfit();
        
        refreshBtn.disabled = false;
        loadingContainer.classList.add('hidden');
      }, 500);
    }

    // 모든 아이템 가격 가져오기
    function fetchAllPrices() {
      refreshBtn.disabled = true;
      loadingContainer.classList.remove('hidden');
      apiErrorEl.style.display = 'none';
    
      updateItemStatus('loading');
    
      const itemsToFetch = yokaiRewards.filter(reward => reward.tradable && !reward.fixedPrice && reward.searchName);
    
      if (DEBUG_MODE) {
        debugInfoEl.innerHTML = `검색할 아이템: ${itemsToFetch.map(item => item.name).join(', ')}`;
      }
    
      const fetchPromises = itemsToFetch.map(reward => {
        const itemName = encodeURIComponent(reward.searchName);
        const corsProxy = 'https://cors-anywhere.herokuapp.com/';
        const apiUrl = `${corsProxy}https://api.neople.co.kr/df/auction-sold?itemName=${itemName}&wordType=match&wordShort=true&limit=10&apikey=${API_KEY}`;
      
        if (DEBUG_MODE) {
          console.log(`${reward.name} 검색 URL: ${apiUrl}`);
          debugInfoEl.innerHTML += `<br>${reward.name} API 호출 중...`;
        }
      
        return fetch(apiUrl)
          .then(response => {
            if (!response.ok) {
              throw new Error(`API 응답 오류: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data && data.rows && data.rows.length > 0) {
              const prices = data.rows.map(item => item.unitPrice);
              const avgPrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
              reward.price = Math.floor(avgPrice);
              reward.avgPrice = Math.floor(avgPrice);
              reward.lastUpdate = new Date();
              reward.status = 'success';
            
              if (DEBUG_MODE) {
                console.log(`${reward.name} 가격 설정: ${reward.price} 골드`);
                debugInfoEl.innerHTML += `<br>${reward.name} 가격: ${reward.price} 골드 (성공)`;
              }
            } else {
              throw new Error('데이터를 찾을 수 없습니다');
            }
          })
          .catch(error => {
            console.error(`${reward.name} 가격 로드 오류:`, error);
            reward.status = 'error';
            reward.errorMessage = error.message;
          
            if (DEBUG_MODE) {
              debugInfoEl.innerHTML += `<br>${reward.name} 오류: ${error.message}`;
            }
            
            // 테스트용 기본값
            if (reward.id === 'remnant-tradable') {
              reward.price = 10500;
            } else if (reward.id === 'lion-core') {
              reward.price = 22000;
            } else if (reward.id === 'harmony') {
              reward.price = 32000;
            } else if (reward.id === 'clue') {
              reward.price = 550000;
            }
          });
      });
    
      Promise.allSettled(fetchPromises)
        .then(results => {
          if (DEBUG_MODE) {
            console.log('모든 API 호출 결과:', results);
            debugInfoEl.innerHTML += '<br>모든 API 호출 완료';
          }
        
          updateMarketPricesUI();
          displayRewardInfo();
          calculateExpectedProfit();
        })
        .catch(error => {
          console.error('API 오류:', error);
          apiErrorEl.textContent = '경매장 정보를 가져오는데 실패했습니다. 잠시 후 다시 시도해주세요.';
          apiErrorEl.style.display = 'block';
        
          if (DEBUG_MODE) {
            debugInfoEl.innerHTML += `<br>전체 API 오류: ${error.message}`;
          }
        })
        .finally(() => {
          refreshBtn.disabled = false;
          loadingContainer.classList.add('hidden');
        });
    }

    // 모든 아이템의 상태 업데이트
    function updateItemStatus(status) {
      yokaiRewards.forEach(reward => {
        if (reward.tradable && !reward.fixedPrice) {
          reward.status = status;
        }
      });
    }

    // 시장 가격 UI 업데이트
    function updateMarketPricesUI() {
      marketPricesEl.innerHTML = '';
      
      yokaiRewards.forEach(reward => {
        if (reward.tradable && !reward.fixedPrice) {
          const statusClass = reward.status === 'success' ? 'status-success' : 
                            reward.status === 'error' ? 'status-error' : 'status-loading';
          
          const itemEl = document.createElement('div');
          itemEl.className = 'item-price';
          
          let priceText = '로딩 중...';
          if (reward.status === 'success') {
            priceText = `${formatNumber(reward.price)} 골드`;
            if (reward.id === 'clue' && reward.npcPrice) {
              priceText += ` (NPC: ${formatNumber(reward.npcPrice)} 골드)`;
            }
          } else if (reward.status === 'error') {
            priceText = '가격 정보 없음';
          }
          
          itemEl.innerHTML = `
            <div class="item-info">
              <div>
                <span class="status-indicator ${statusClass}"></span>
                <span>${reward.name}:</span>
                <span class="market-price">${priceText}</span>
              </div>
              ${reward.errorMessage ? `<div class="untradable">오류: ${reward.errorMessage}</div>` : ''}
            </div>
          `;
          
          marketPricesEl.appendChild(itemEl);
        }
      });
    }

    // 보상 정보 표시
    function displayRewardInfo() {
      rewardListEl.innerHTML = '';
      
      let totalValue = 0;
      let tradableValue = 0;
      let untradableValue = 0;
      
      yokaiRewards.forEach(reward => {
        const rewardValue = Math.floor(reward.avgQuantity * reward.price);
        totalValue += rewardValue;
        
        if (reward.tradable) {
          tradableValue += rewardValue;
        } else {
          untradableValue += rewardValue;
        }
        
        const rewardEl = document.createElement('div');
        rewardEl.className = 'reward-item';
        
        rewardEl.innerHTML = `
          <div>
            <span>${reward.name}</span>
            <span class="amount">(평균 ${reward.avgQuantity.toFixed(2)}개)</span>
            ${!reward.tradable ? '<span class="untradable"></span>' : ''}
          </div>
          <div>${formatNumber(rewardValue)} 골드</div>
        `;
        
        rewardListEl.appendChild(rewardEl);
      });
      
      totalValueDisplayEl.innerHTML = `총 기대가치 <span class="untradable-value">(${formatNumber(Math.floor(untradableValue))})</span> <span class="total-sum-value">${formatNumber(Math.floor(totalValue))}</span> 골드`;
    }

    // 기대 수익 계산 (NPC 구매는 재귀적 효과 반영)
    function calculateExpectedProfit() {
      let totalExpectedValue = 0;
      let tradableValue = 0;
      let untradableValue = 0;
      
      yokaiRewards.forEach(reward => {
        const rewardValue = reward.avgQuantity * reward.price;
        totalExpectedValue += rewardValue;
        
        if (reward.tradable) {
          tradableValue += rewardValue;
        } else {
          untradableValue += rewardValue;
        }
      });
      
      totalExpectedValue = Math.floor(totalExpectedValue);
      tradableValue = Math.floor(tradableValue);
      untradableValue = Math.floor(untradableValue);
      
      const clueItem = yokaiRewards.find(item => item.id === 'clue');
      const clueMarketPrice = clueItem ? clueItem.price : 0;
      const clueNpcPrice = clueItem && clueItem.npcPrice ? clueItem.npcPrice : 0;
      
      // 경매장 구매 시 순이익 (단순 차감)
      const marketNetProfit = tradableValue - clueMarketPrice;
      
      // NPC 구매의 경우, 재귀적 효과를 고려:
      // 기존 tradableValue에는 '형상화된 요기의 단서' 항목도 포함되므로, NPC 선택에서는 그 부분을 제거하고,
      // 대신 재귀적으로 npc 구매 시 기대 수익을 더하는 형태로 계산.
      let npcNetProfit = 0;
      if (clueItem) {
        const clueAvg = clueItem.avgQuantity;
        // tradableValue에서 단서의 경매상 항목 기여분 제거
        const tradableWithoutClue = tradableValue - (clueAvg * clueItem.price);
        // 재귀 공식: Profit_NPC = (tradableWithoutClue - clueNpcPrice + (clueAvg * Profit_NPC))
        // → (1 - clueAvg)*Profit_NPC = tradableWithoutClue - clueNpcPrice
        npcNetProfit = (tradableWithoutClue - clueNpcPrice) / (1 - clueAvg);
        npcNetProfit = Math.floor(npcNetProfit);
      }
      
      // 결과 출력 (두 방식을 모두 표시)
      const resultHTML = `
        <p>형상화된 요기의 단서 경매장 구매 비용: <b>${formatNumber(clueMarketPrice)} 골드</b></p>
        <p>형상화된 요기의 단서 NPC 구매 비용 (고정): <b>${formatNumber(clueNpcPrice)} 골드</b></p>
        <p>요괴 섬멸 컨텐츠 평균 획득량: <b>${clueItem ? clueItem.avgQuantity.toFixed(3) : 0}개</b></p>
        <div class="profit-summary">
          <p>경매장 구매 시 기대 수익: <span class="${marketNetProfit >= 0 ? 'profit-positive' : 'profit-negative'}">${formatNumber(marketNetProfit)} 골드</span></p>
          <p>NPC(재귀 효과 적용) 구매 시 기대 수익: <span class="${npcNetProfit >= 0 ? 'profit-positive' : 'profit-negative'}">${formatNumber(npcNetProfit)} 골드</span></p>
        </div>
      `;
      
      resultContainer.innerHTML = resultHTML;
      totalProfitEl.innerHTML = resultHTML;
    }

    // 숫자 포맷팅
    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
  </script>
</body>
</html>
